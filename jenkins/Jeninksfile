pipeline {
    agent any
    stages {
        // 환경 초기화 또는 클린업 단계
        stage('Prepare Workspace') {
            steps {
                deleteDir()
            }
        }

        //  Git에서 코드를 클론합니다.
        stage('Clone Repository') {
            steps {
                git branch: 'app_deploy', url: 'https://github.com/Jaeki-Lee/infra-deploy.git'
            }
        }

        // Control Server로 코드를 전송합니다.
        stage('Transfer to Control Server') {
            steps {
                sshagent(['control-server-ssh-key']) {
                    sh '''
                        rsync -av --exclude='.git' -e "ssh -o StrictHostKeyChecking=no" /var/lib/jenkins/workspace/infra-deploy/ user1@192.168.3.129:/home/user1/infra-deploy/
                    '''
                }
            }
        }

        //  Control Server에서 Ansible Playbook을 실행합니다.
        stage('Run Ansible Playbook') {
            steps {
                sshagent(['control-server-ssh-key']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no user1@192.168.3.129 '
                            cd /home/user1/infra-deploy/ansible &&
                            ansible-playbook -i inventory.yml playbooks/deploy_control.yml --ask-become-pass

                        '
                    '''
                }
            }
        }

        // Control Server에서 DB HA Playbook을 실행합니다.
        stage('Run DB HA Playbook') {
            steps {
                sshagent(['control-server-ssh-key']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no user1@192.168.3.129 '
                            cd /home/user1/infra-deploy/ansible &&
                            ansible-playbook -i inventory.yml playbooks/deploy_db.yml --ask-become-pass
                        '
                    '''
                }
            }
        }

        // Control Server에서 App Playbook을 실행합니다.
        stage('Run App Playbook') {
            steps {
                sshagent(['control-server-ssh-key']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no user1@192.168.3.129 '
                            cd /home/user1/infra-deploy/ansible &&
                            ansible-playbook -i inventory.yml playbooks/deploy_app.yml --ask-become-pass
                        '
                    '''
                }
            }
        }

    }
}
